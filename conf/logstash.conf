input {
	file {
		path => "/var/log/openstack/nova/nova.log"
		type => "nova"
	}

	file {
		path => "/var/log/openstack/glance/glance.log"
		type => "glance"
	}

	file {
		path => "/var/log/openstack/neutron/neutron.log"
		type => "neutron"
	}

        file {
                path => "/var/log/openstack/cinder/cinder.log"
                type => "cinder"
        }

        file {
                path => "/var/log/openstack/heat/heat.log"
                type => "heat"
        }

	file {
		path => "/var/log/openstack/keystone/keystone.log"
		type => "keystone"
	}
}

filter {
	if [type] == "nova" {
		grok {
			break_on_match => true
			match => [
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{ID} %{GREEDYDATA:openstack_instance_action}",
			#	"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GREEDYDATA:openstack_message}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{NOTSPACE} %{RESOURCE_DISK_RAM:Free_disk_ram}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{NOTSPACE} %{RESOURCE_CPU:Free_vcpus}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{COMPUTE_SERVICE:compute_service_record}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{WORD} %{NOTSPACE:openstack_image_id} %{NOTSPACE} %{NOTSPACE:openstack_image_location} %{GREEDYDATA:image_message}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{BASE_FILE} %{PATH:openstack_basefile_path}"
			]
			add_tag => "openstack_logs"
			add_tag => "nova"
		}
	if ([message] =~"Compute_service record") or ([message] =~"Auditing locally") {
		drop {}
	}
	}

	if [type] == "glance" {
		grok {
			break_on_match => true
			match => [
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GREEDYDATA:test} %{IP:IP}",
			#	"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GLANCE_IMAGE_MESSAGE:glance_image_message}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GLANCE_IMAGE_MESSAGE:glance_image_message} %{UUID:glance_image_id}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{IP:IP} %{GREEDYDATA} %{QUOTEDSTRING:glance_image_request} %{INT:glance_response_code} %{INT} %{NOTSPACE:glance_response_duration}"
			]
			add_tag => "openstack_logs"
			add_tag => "glance"
		}

	if ([message] =~"Returning detailed image list") {
		drop {}
	}
	}

	if [type] == "neutron" {
		grok {
			break_on_match => true
			match => [
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{DATA} %{UUID:neutron_segment_id} %{WORD} %{WORD} %{WORD:neutron_network_type} %{WORD} %{WORD} %{UUID:neutron_network_id}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{IP:IP} %{GREEDYDATA} %{QUOTEDSTRING:neutron_network_request} %{INT:neutron_response_code} %{INT} %{NOTSPACE:neutron_response_duration}",
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{NEUTRON_ACCEPT_MESSAGE:neutron_accept_message}"
			]
			add_tag => "openstack_logs"
			add_tag => "neutron"
		}

	if ([message] =~"Starting new HTTP connection"){
                drop {}
        }
	}

	if [type] == "keystone" {
                grok {
                        break_on_match => true
                        match => [
                                 "message", " %{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{IP:IP} %{GREEDYDATA:test} %{QUOTEDSTRING:keystone_request} %{INT:keystone_response_code} %{INT} %{NOTSPACE:keystone_response_duration}"
                        ]
                        add_tag => "openstack_logs"
                        add_tag => "keystone"
                }
        }

	
	# Not much to monitor at the moment. Using general filter
	if [type] == "cinder" {
		grok {
			break_on_match => true
			match => [
				 "message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GREEDYDATA:cinder_message}"
			]
			add_tag => "openstack_logs"
			add_tag => "cinder"
		}
	}
	
        if [type] == "heat" {
                grok {
                        break_on_match => true
                        match => [
                                 "message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GREEDYDATA:heat_message}"
                        ]
                        add_tag => "openstack_logs"
                        add_tag => "heat"
                }
        }

if  ([openstack_program] =~"keystoneclient.middleware.auth_token") {
	drop {}
}

	if ([message] =~"Quota exceeded for resources") {
		grok {
			match => [
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GREEDYDATA:resource_failed}"
			]
			add_tag => "openstack_logs"
			add_tag => "resource_quota"
			remove_tag => "_grokparsefailure"
		}
	}
	# All matching filter for grokparsefailures
	if "_grokparsefailure" in [tags] {
		grok {
			match => [
				"message", "%{HOSTNAME:openstack_hostname} %{TIMESTAMP_ISO8601:timestamp}%{OPENSTACK_PID:openstack_pid} %{OPENSTACK_LOGLEVEL:openstack_loglevel} %{OPENSTACK_PROG:openstack_program}%{REQ_LIST} %{GREEDYDATA:openstack_message}"
			]
			add_tag => "openstack_logs"
			add_tag => "unmatched_event"
			remove_tag => "_grokparsefailure"
		}
	}
}

output {
	elasticsearch {
		host => "localhost:9200"
		protocol => "http"
		cluster => "vagrant_elasticsearch"
		manage_template => false
	}

	# Counters - statsd
	if "Instance spawned successfully" in [openstack_instance_action] {
		statsd {
			increment => "openstack_running_instances"
#			count => ["openstack_running_instances", 1]
		}
	}

	if "Instance destroyed successfully" in [openstack_instance_action] {
		statsd {
			decrement => "openstack_running_instances.count"
#			count => ["openstack_running_instances", openstack_running_instances-1"
		}
	}


#	graphite {
#		host => "192.168.11.18"
#			metrics => [
#				"%{openstack_hostname}.%{openstack_program}.%{glance_response_code}", "%{glance_response_duration}",
#				"%{openstack_hostname}.%{openstack_program}.%{neutron_response_code}", "%{neutron_response_duration}",
#				"%{openstack_hostname}.%{openstack_program}.%{keystone_response_code}", "%{keystone_response_duration}"
#			]
#	}



#	if "200" in [glance_response_code] {
#		statsd {
#			gauge => [
#				"%{openstack_hostname}.%{glance_response_code}", "%{glance_response_duration}",
#			]
#		}
##	}



#	statsd {
#		gauge => [
#			"%{openstack_hostname}.%{glance_response_code}", "%{glance_response_duration}",
#                        "%{openstack_hostname}.%{neutron_response_code}", "%{neutron_response_duration}",
#                        "%{openstack_hostname}.%{keystone_response_code}", "%{keystone_response_duration}"
#		]
#	}


#	# Metrics
#	if "Free VCPUS" in [Free_vcpus] {
#		graphite {
#			host => "192.168.11.18"
#			metrics => [ "%{openstack_hostname}.free-vcpus", "%{Free_vcpus_count}"]
#		}
#	}
#
#	if "Free ram" in [Free_disk_ram] {
#		graphite {
#			host => "192.168.11.18"
#			metrics => [ "%{openstack_hostname}.free-ram", "%{Free_disk_ram_count}"]
#		}
#	}
#	
#	if "Free disk" in [Free_disk_ram] {
#		graphite {
#			host => "192.168.11.18"
#			metrics => [ "%{openstack_hostname}.free-disk", "%{Free_disk_ram_count}"]
#		}
#	}
	
#	if "glance" in [openstack_program] {
#		graphite {
#			host => "192.168.11.18"
#			metrics => ["%{openstack_hostname}.glance-image-request.%{glance_response_code}", "%{glance_response_duration}"]
#		}
#	}

#	graphite {
#		host => "192.168.11.18"
#		metrics => [ "%{openstack_hostname}.openstack_loglevel", "%{openstack_loglevel}"]
#
#	}

#	graphite {
#		host => "192.168.11.18"
#		metrics => [ "running_instances", "openstack_running_instsances"]
#
#	}

	statsd {
		increment => "%{openstack_loglevel}"
	}

	statsd {
		increment => "%{openstack_program}"
	}

	file {
		path => "/var/log/openstack/%{openstack_hostname}-%{+YYYY-MM-dd}.log"
		codec => "rubydebug"
	}
}
